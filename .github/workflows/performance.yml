# =============================================================================
# Fight Club - Performance Testing Pipeline
# =============================================================================
# Triggers: Pull requests and pushes to main
# Actions: Run benchmarks, stress tests, enforce performance gates
# =============================================================================

name: Performance Tests

on:
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'fight-club-go/**/*.go'
      - '.github/workflows/performance.yml'
  push:
    branches:
      - main
      - master
    paths:
      - 'fight-club-go/**/*.go'

# Cancel in-progress runs for the same branch
concurrency:
  group: performance-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.24'

  # =============================================================================
  # PERFORMANCE THRESHOLDS (KPIs)
  # These are the gates that must pass for deployment
  # =============================================================================

  # Engine tick time thresholds (nanoseconds)
  MAX_TICK_10_PLAYERS_NS: 500000      # 500µs max for 10 players
  MAX_TICK_50_PLAYERS_NS: 2000000     # 2ms max for 50 players
  MAX_TICK_100_PLAYERS_NS: 5000000    # 5ms max for 100 players
  MAX_TICK_200_PLAYERS_NS: 15000000   # 15ms max for 200 players

  # Snapshot generation thresholds (nanoseconds)
  MAX_SNAPSHOT_50_PLAYERS_NS: 500000  # 500µs max for 50 players
  MAX_SNAPSHOT_100_PLAYERS_NS: 1000000 # 1ms max for 100 players

  # Memory allocation thresholds (bytes per operation)
  MAX_ALLOCS_PER_TICK_50_PLAYERS: 5000    # Max bytes allocated per tick
  MAX_ALLOCS_SNAPSHOT_50_PLAYERS: 10000   # Max bytes per snapshot

  # Stress test thresholds
  MIN_TPS_SUSTAINED: 21.6           # 90% of 24 FPS target
  MAX_P99_LATENCY_MS: 50            # P99 tick time

jobs:
  # ===========================================================================
  # Job 1: Run Benchmarks with Threshold Enforcement
  # ===========================================================================
  benchmarks:
    name: Benchmark Tests
    runs-on: ubuntu-latest
    outputs:
      benchmark_passed: ${{ steps.check.outputs.passed }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: fight-club-go/go.sum

      - name: Download dependencies
        working-directory: ./fight-club-go
        run: go mod download

      - name: Run benchmarks
        id: bench
        working-directory: ./fight-club-go
        run: |
          echo "Running benchmark suite..."
          go test -bench=. -benchmem -benchtime=3s -count=3 \
            ./internal/game/... 2>&1 | tee benchmark_results.txt

          # Parse benchmark results for threshold checking
          echo "=== Benchmark Results ===" >> $GITHUB_STEP_SUMMARY
          cat benchmark_results.txt >> $GITHUB_STEP_SUMMARY

      - name: Check performance thresholds
        id: check
        working-directory: ./fight-club-go
        run: |
          #!/bin/bash
          set -e

          FAILED=0

          # Function to extract benchmark value (ns/op)
          extract_ns() {
            grep "$1" benchmark_results.txt | head -1 | awk '{print $3}' | tr -d 'ns/op'
          }

          # Function to extract allocations (B/op)
          extract_allocs() {
            grep "$1" benchmark_results.txt | head -1 | awk '{print $5}' | tr -d 'B/op'
          }

          echo "## Performance Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check Engine Tick benchmarks
          check_threshold() {
            local name="$1"
            local pattern="$2"
            local max_ns="$3"
            local result
            result=$(extract_ns "$pattern")

            if [ -n "$result" ]; then
              result_int=${result%.*}
              if [ "$result_int" -gt "$max_ns" ]; then
                echo "❌ $name: ${result}ns > ${max_ns}ns threshold" >> $GITHUB_STEP_SUMMARY
                FAILED=1
              else
                echo "✅ $name: ${result}ns <= ${max_ns}ns threshold" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "⚠️ $name: Could not extract benchmark result" >> $GITHUB_STEP_SUMMARY
            fi
          }

          echo "### Engine Tick Performance" >> $GITHUB_STEP_SUMMARY
          check_threshold "10 Players Tick" "BenchmarkEngineTick_10Players" "$MAX_TICK_10_PLAYERS_NS"
          check_threshold "50 Players Tick" "BenchmarkEngineTick_50Players" "$MAX_TICK_50_PLAYERS_NS"
          check_threshold "100 Players Tick" "BenchmarkEngineTick_100Players" "$MAX_TICK_100_PLAYERS_NS"
          check_threshold "200 Players Tick" "BenchmarkEngineTick_200Players" "$MAX_TICK_200_PLAYERS_NS"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Snapshot Generation" >> $GITHUB_STEP_SUMMARY
          check_threshold "50 Players Snapshot" "BenchmarkProduceSnapshot_50Players" "$MAX_SNAPSHOT_50_PLAYERS_NS"
          check_threshold "100 Players Snapshot" "BenchmarkProduceSnapshot_100Players" "$MAX_SNAPSHOT_100_PLAYERS_NS"

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$FAILED" -eq 1 ]; then
            echo "::error::Performance thresholds exceeded! See summary for details."
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "### ✅ All performance gates passed!" >> $GITHUB_STEP_SUMMARY
            echo "passed=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: benchmark-results
          path: fight-club-go/benchmark_results.txt
          retention-days: 30

  # ===========================================================================
  # Job 2: Run Stress Tests (longer duration, validates stability)
  # ===========================================================================
  stress-tests:
    name: Stress Tests
    runs-on: ubuntu-latest
    needs: benchmarks
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: fight-club-go/go.sum

      - name: Download dependencies
        working-directory: ./fight-club-go
        run: go mod download

      - name: Run stress tests
        working-directory: ./fight-club-go
        run: |
          echo "Running stress test suite..."
          go test -v -run=TestStress -timeout=120s \
            ./internal/game/... 2>&1 | tee stress_results.txt

          echo "=== Stress Test Results ===" >> $GITHUB_STEP_SUMMARY

          # Check for failures
          if grep -q "FAIL" stress_results.txt; then
            echo "::error::Stress tests failed!"
            cat stress_results.txt >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "### ✅ All stress tests passed!" >> $GITHUB_STEP_SUMMARY
          grep -E "(PASS|Stress Test Results|Spike Test|Memory Pressure)" stress_results.txt >> $GITHUB_STEP_SUMMARY || true

      - name: Run latency tests
        working-directory: ./fight-club-go
        run: |
          echo "Running latency tests..."
          go test -v -run=TestLatency -timeout=60s \
            ./internal/game/... 2>&1 | tee latency_results.txt

          if grep -q "FAIL" latency_results.txt; then
            echo "::error::Latency tests failed!"
            exit 1
          fi

      - name: Upload stress test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: stress-results
          path: |
            fight-club-go/stress_results.txt
            fight-club-go/latency_results.txt
          retention-days: 30

  # ===========================================================================
  # Job 3: Memory Profile Analysis
  # ===========================================================================
  memory-analysis:
    name: Memory Analysis
    runs-on: ubuntu-latest
    needs: benchmarks
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: fight-club-go/go.sum

      - name: Download dependencies
        working-directory: ./fight-club-go
        run: go mod download

      - name: Run memory benchmarks
        working-directory: ./fight-club-go
        run: |
          echo "Running memory allocation analysis..."
          go test -bench=BenchmarkMemoryAllocation -benchmem -memprofile=mem.prof \
            ./internal/game/... 2>&1 | tee memory_results.txt

          echo "## Memory Analysis" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat memory_results.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check for memory leaks
        working-directory: ./fight-club-go
        run: |
          go test -v -run=TestStress_MemoryPressure -timeout=60s ./internal/game/...

      - name: Upload memory profile
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: memory-profile
          path: |
            fight-club-go/mem.prof
            fight-club-go/memory_results.txt
          retention-days: 7

  # ===========================================================================
  # Job 4: Performance Regression Detection (compare against base branch)
  # ===========================================================================
  regression-check:
    name: Regression Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          path: pr

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: base

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run baseline benchmarks
        working-directory: ./base/fight-club-go
        run: |
          go mod download
          go test -bench=BenchmarkEngineTick -benchmem -benchtime=2s -count=3 \
            ./internal/game/... 2>&1 | tee ../baseline.txt || true

      - name: Run PR benchmarks
        working-directory: ./pr/fight-club-go
        run: |
          go mod download
          go test -bench=BenchmarkEngineTick -benchmem -benchtime=2s -count=3 \
            ./internal/game/... 2>&1 | tee ../pr_results.txt || true

      - name: Compare results
        run: |
          echo "## Performance Regression Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Baseline (${GITHUB_BASE_REF})" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep "BenchmarkEngineTick" baseline.txt >> $GITHUB_STEP_SUMMARY || echo "No baseline results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### PR Branch" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep "BenchmarkEngineTick" pr_results.txt >> $GITHUB_STEP_SUMMARY || echo "No PR results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # TODO: Add benchstat comparison when benchmark history is established

  # ===========================================================================
  # Final Gate: Summary
  # ===========================================================================
  performance-gate:
    name: Performance Gate
    runs-on: ubuntu-latest
    needs: [benchmarks, stress-tests, memory-analysis]
    if: always()

    steps:
      - name: Check all gates
        run: |
          if [ "${{ needs.benchmarks.result }}" != "success" ]; then
            echo "::error::Benchmark tests failed"
            exit 1
          fi
          if [ "${{ needs.stress-tests.result }}" != "success" ]; then
            echo "::error::Stress tests failed"
            exit 1
          fi
          if [ "${{ needs.memory-analysis.result }}" != "success" ]; then
            echo "::error::Memory analysis failed"
            exit 1
          fi

          echo "## ✅ All Performance Gates Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following checks completed successfully:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Benchmark thresholds" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Stress tests" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Memory analysis" >> $GITHUB_STEP_SUMMARY
