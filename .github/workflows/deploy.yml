# =============================================================================
# Fight Club - CI/CD Pipeline
# =============================================================================
# Triggers: Push to main/master, Manual dispatch
# Actions: Build, Test, Create Docker image, Deploy to Oracle Cloud
# =============================================================================

name: Build & Deploy

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests'
        required: false
        default: 'false'
        type: boolean
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        default: 'false'
        type: boolean

jobs:
  # ===========================================================================
  # Job 1: Run Tests
  # ===========================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_tests != 'true' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: fight-club-go/go.sum

      - name: Download dependencies
        working-directory: ./fight-club-go
        run: go mod download

      - name: Run tests
        working-directory: ./fight-club-go
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./fight-club-go/coverage.out
          fail_ci_if_error: false
        continue-on-error: true

  # ===========================================================================
  # Job 2: Deploy to Contabo VPS
  # ===========================================================================
  deploy:
    name: Deploy to Contabo VPS
    runs-on: ubuntu-latest
    needs: [test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped' || github.event.inputs.force_deploy == 'true')

    steps:
      - name: Deploy to Contabo via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.CONTABO_HOST }}
          username: ${{ secrets.CONTABO_USERNAME }}
          password: ${{ secrets.CONTABO_PASSWORD }}
          port: 22
          script: |
            set -e

            echo "üöÄ Starting deployment..."
            cd /opt/fight-club

            # Pull latest changes
            echo "üì• Pulling latest changes..."
            git fetch origin main
            git reset --hard origin/main

            # Stop current container
            echo "‚èπÔ∏è Stopping current container..."
            docker compose down || true

            # Rebuild and start
            echo "‚ñ∂Ô∏è Building and starting container..."
            docker compose up -d --build

            # Health check
            echo "üè• Running health check..."
            sleep 15
            curl -f http://localhost:3000/api/state || echo "Health check skipped"

            echo "‚úÖ Deployment successful!"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment to Contabo VPS successful!"
          else
            echo "‚ùå Deployment failed!"
          fi
